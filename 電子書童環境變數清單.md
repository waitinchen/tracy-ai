# 電子書童專案 Service Variables 清單

**專案名稱**: 換框思維｜電子書童 (Digital Reading Companion)  
**文件版本**: v1.0  
**最後更新**: 2025-01-XX

---

## 📋 目錄

1. [必需環境變數（核心功能）](#必需環境變數核心功能)
2. [可選環境變數（擴展功能）](#可選環境變數擴展功能)
3. [環境變數分類](#環境變數分類)
4. [設定指南](#設定指南)
5. [驗證檢查](#驗證檢查)

---

## 一、必需環境變數（核心功能）

### 1.1 Supabase 配置（認證與資料庫）

**用途**: 用戶認證、資料庫儲存、RLS 安全

| 變數名稱 | 類型 | 說明 | 範例值 |
|---------|------|------|--------|
| `NEXT_PUBLIC_SUPABASE_URL` | **必需** | Supabase 專案 URL | `https://xxx.supabase.co` |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | **必需** | Supabase 匿名金鑰（公開） | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` |
| `NEXT_PUBLIC_SITE_URL` | **必需** | 網站部署 URL | `https://your-domain.com` |

**取得方式**:
1. 前往 [Supabase Dashboard](https://supabase.com/dashboard)
2. 選擇專案 → Settings → API
3. 複製 `Project URL` 和 `anon public` key

**使用位置**:
- `app/utils/supabase/client.ts`
- `app/lib/supabase-server.ts`
- `app/lib/soul/get-system-prompt.ts`

---

### 1.2 LLM 服務配置（對話生成）

**用途**: 生成電子書童的回應

#### Google Gemini（主要 LLM）

| 變數名稱 | 類型 | 說明 | 範例值 |
|---------|------|------|--------|
| `GOOGLE_API_KEY` | **必需** | Google Gemini API 金鑰 | `AIzaSy...` |

**取得方式**:
1. 前往 [Google AI Studio](https://makersuite.google.com/app/apikey)
2. 建立新的 API Key
3. 複製金鑰

**使用位置**:
- `app/lib/soul/llm-service.ts`
- `app/lib/memory/llm-analyzer.ts`
- `app/api/health-check/route.ts`

#### Anthropic Claude（備選 LLM，可選）

| 變數名稱 | 類型 | 說明 | 範例值 |
|---------|------|------|--------|
| `ANTHROPIC_API_KEY` | 可選 | Anthropic Claude API 金鑰 | `sk-ant-...` |

**取得方式**:
1. 前往 [Anthropic Console](https://console.anthropic.com/)
2. 建立 API Key
3. 複製金鑰

**備註**: 目前主要使用 Google Gemini，Claude 為備選方案。

---

### 1.3 語音合成配置（ElevenLabs）

**用途**: 將電子書童回應轉換為語音

| 變數名稱 | 類型 | 說明 | 範例值 |
|---------|------|------|--------|
| `ELEVENLABS_API_KEY` | **必需** | ElevenLabs API 金鑰 | `xxx...` |
| `ELEVENLABS_VOICE_ID` | **必需** | 語音 ID（書童聲音） | `WUEPpaWdYrRSq7wyeO9O` |
| `ELEVENLABS_MODEL_ID` | 可選 | 語音模型 ID | `eleven_multilingual_v2`（預設） |

**取得方式**:
1. 前往 [ElevenLabs](https://elevenlabs.io/)
2. 註冊帳號並取得 API Key
3. 選擇或建立語音，取得 Voice ID

**使用位置**:
- `app/lib/elevenlabs-client.ts`
- `app/api/chat/route.ts`
- `app/api/health-check/route.ts`

**備註**: 電子書童需要「沉靜、低存在感」的語音，建議選擇溫和、不搶眼的聲音。

---

## 二、可選環境變數（擴展功能）

### 2.1 Cloudflare KV（記憶系統）

**用途**: 儲存閱讀進度、讀者思考、書籤等記憶

| 變數名稱 | 類型 | 說明 | 範例值 |
|---------|------|------|--------|
| `CLOUDFLARE_KV_NAMESPACE` | 可選 | Cloudflare KV Namespace ID | `xxx...` |
| `CLOUDFLARE_ACCOUNT_ID` | 可選 | Cloudflare Account ID | `xxx...` |
| `CLOUDFLARE_API_TOKEN` | 可選 | Cloudflare API Token | `xxx...` |

**取得方式**:
1. 前往 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. Workers & Pages → KV → Create a namespace
3. 取得 Namespace ID 和 Account ID
4. 建立 API Token（需要 KV 權限）

**使用位置**:
- `app/lib/memory/memory-service-v5.ts`
- Cloudflare Workers（如果使用）

**備註**: 如果使用 Supabase 儲存記憶，此項可選。

---

### 2.2 Cloudflare Workers（記憶 API）

**用途**: 記憶系統的外部 API（如果使用 Cloudflare Workers）

| 變數名稱 | 類型 | 說明 | 範例值 |
|---------|------|------|--------|
| `NEXT_PUBLIC_MEMORY_URL` | 可選 | Memory Worker API URL | `https://xxx.workers.dev` |
| `NEXT_PUBLIC_TIMELINE_URL` | 可選 | Timeline Worker API URL | `https://xxx.workers.dev` |

**取得方式**:
1. 部署 Cloudflare Worker
2. 取得 Worker URL

**使用位置**:
- `app/lib/memory/memory-service-v5.ts`
- `app/lib/timeline/timeline-service.ts`

---

### 2.3 開發環境配置

| 變數名稱 | 類型 | 說明 | 範例值 |
|---------|------|------|--------|
| `NODE_ENV` | 自動 | 環境模式 | `development` / `production` |

**備註**: Next.js 自動設定，通常不需要手動配置。

---

## 三、環境變數分類

### 3.1 按優先級分類

#### 🔴 最高優先級（核心功能無法運作）

1. `NEXT_PUBLIC_SUPABASE_URL`
2. `NEXT_PUBLIC_SUPABASE_ANON_KEY`
3. `NEXT_PUBLIC_SITE_URL`
4. `GOOGLE_API_KEY`
5. `ELEVENLABS_API_KEY`
6. `ELEVENLABS_VOICE_ID`

#### 🟡 中等優先級（功能受限但可運作）

1. `ANTHROPIC_API_KEY`（備選 LLM）
2. `ELEVENLABS_MODEL_ID`（有預設值）

#### 🟢 低優先級（擴展功能）

1. `CLOUDFLARE_KV_NAMESPACE`
2. `CLOUDFLARE_ACCOUNT_ID`
3. `CLOUDFLARE_API_TOKEN`
4. `NEXT_PUBLIC_MEMORY_URL`
5. `NEXT_PUBLIC_TIMELINE_URL`

---

### 3.2 按功能模組分類

#### 認證與資料庫模組
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `NEXT_PUBLIC_SITE_URL`

#### 對話生成模組
- `GOOGLE_API_KEY`
- `ANTHROPIC_API_KEY`（可選）

#### 語音合成模組
- `ELEVENLABS_API_KEY`
- `ELEVENLABS_VOICE_ID`
- `ELEVENLABS_MODEL_ID`（可選）

#### 記憶系統模組
- `CLOUDFLARE_KV_NAMESPACE`（可選）
- `CLOUDFLARE_ACCOUNT_ID`（可選）
- `CLOUDFLARE_API_TOKEN`（可選）
- `NEXT_PUBLIC_MEMORY_URL`（可選）
- `NEXT_PUBLIC_TIMELINE_URL`（可選）

---

## 四、設定指南

### 4.1 本地開發環境（`.env.local`）

在 `megan/` 目錄下建立 `.env.local` 檔案：

```env
# ============================================
# 電子書童專案環境變數配置
# ============================================

# --- Supabase 配置（必需）---
NEXT_PUBLIC_SUPABASE_URL=https://tqummhyhohacbkmpsgae.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=你的_supabase_anon_key
NEXT_PUBLIC_SITE_URL=http://localhost:3000

# --- LLM 服務配置（必需）---
GOOGLE_API_KEY=你的_google_api_key

# --- 語音合成配置（必需）---
ELEVENLABS_API_KEY=你的_elevenlabs_api_key
ELEVENLABS_VOICE_ID=WUEPpaWdYrRSq7wyeO9O
ELEVENLABS_MODEL_ID=eleven_multilingual_v2

# --- 備選 LLM（可選）---
ANTHROPIC_API_KEY=你的_anthropic_api_key

# --- Cloudflare 配置（可選）---
CLOUDFLARE_KV_NAMESPACE=你的_namespace
CLOUDFLARE_ACCOUNT_ID=你的_account_id
CLOUDFLARE_API_TOKEN=你的_api_token
NEXT_PUBLIC_MEMORY_URL=https://xxx.workers.dev
NEXT_PUBLIC_TIMELINE_URL=https://xxx.workers.dev
```

### 4.2 生產環境配置

**部署平台**: Railway / Vercel / 其他

**設定方式**:
1. 在部署平台的環境變數設定頁面
2. 逐一添加上述環境變數
3. 確保所有 `NEXT_PUBLIC_*` 變數都已設定（Next.js 需要）

**重要注意事項**:
- ⚠️ **不要**將 `.env.local` 提交到 Git
- ⚠️ **確保**生產環境的 `NEXT_PUBLIC_SITE_URL` 指向正確的域名
- ⚠️ **檢查**所有 API Key 的權限和配額

---

## 五、驗證檢查

### 5.1 環境變數驗證腳本

可以使用以下腳本驗證環境變數：

```typescript
// scripts/validate-env.ts
const requiredVars = [
  'NEXT_PUBLIC_SUPABASE_URL',
  'NEXT_PUBLIC_SUPABASE_ANON_KEY',
  'NEXT_PUBLIC_SITE_URL',
  'GOOGLE_API_KEY',
  'ELEVENLABS_API_KEY',
  'ELEVENLABS_VOICE_ID',
];

const optionalVars = [
  'ANTHROPIC_API_KEY',
  'ELEVENLABS_MODEL_ID',
  'CLOUDFLARE_KV_NAMESPACE',
  'CLOUDFLARE_ACCOUNT_ID',
  'CLOUDFLARE_API_TOKEN',
  'NEXT_PUBLIC_MEMORY_URL',
  'NEXT_PUBLIC_TIMELINE_URL',
];

function validateEnv() {
  const missing: string[] = [];
  const present: string[] = [];
  const optionalPresent: string[] = [];

  requiredVars.forEach(varName => {
    if (process.env[varName]) {
      present.push(varName);
    } else {
      missing.push(varName);
    }
  });

  optionalVars.forEach(varName => {
    if (process.env[varName]) {
      optionalPresent.push(varName);
    }
  });

  console.log('=== 環境變數驗證結果 ===\n');
  
  if (missing.length > 0) {
    console.error('❌ 缺少必需環境變數:');
    missing.forEach(v => console.error(`   - ${v}`));
    console.error('\n請在 .env.local 中設定這些變數！\n');
    process.exit(1);
  }

  console.log('✅ 必需環境變數已設定:');
  present.forEach(v => console.log(`   - ${v}`));

  if (optionalPresent.length > 0) {
    console.log('\n✅ 可選環境變數已設定:');
    optionalPresent.forEach(v => console.log(`   - ${v}`));
  }

  console.log('\n✅ 環境變數驗證通過！');
}

validateEnv();
```

### 5.2 手動檢查清單

在部署前，請確認：

- [ ] `NEXT_PUBLIC_SUPABASE_URL` 已設定且可訪問
- [ ] `NEXT_PUBLIC_SUPABASE_ANON_KEY` 已設定且有效
- [ ] `NEXT_PUBLIC_SITE_URL` 指向正確的域名
- [ ] `GOOGLE_API_KEY` 已設定且有效
- [ ] `ELEVENLABS_API_KEY` 已設定且有效
- [ ] `ELEVENLABS_VOICE_ID` 已設定且對應的語音存在
- [ ] 所有 API Key 都有足夠的配額
- [ ] 生產環境的環境變數已正確設定

---

## 六、電子書童專案特殊需求

### 6.1 語音選擇建議

**電子書童語音要求**:
- 沉靜、低存在感
- 不搶眼、不激勵
- 溫和、陪讀風格

**建議的 Voice ID**:
- 需要測試多個語音，選擇最符合「書童」風格的
- 避免過於活潑或激勵性的語音

### 6.2 LLM 模型選擇

**目前使用**: `gemini-2.0-flash-exp`

**電子書童需求**:
- 能夠嚴格遵守三步驟回應流程
- 能夠遵守四條紅線
- 能夠引用書中內容而不產生新觀點

**備註**: 可能需要調整模型參數或使用更嚴格的 prompt。

---

## 七、環境變數安全建議

### 7.1 安全最佳實踐

1. **不要提交敏感資訊**
   - `.env.local` 應在 `.gitignore` 中
   - 不要將 API Key 提交到 Git

2. **使用環境變數管理**
   - 本地開發：使用 `.env.local`
   - 生產環境：使用部署平台的環境變數設定

3. **定期輪換 API Key**
   - 定期檢查 API Key 使用情況
   - 發現異常時立即輪換

4. **最小權限原則**
   - API Key 只給予必要的權限
   - 不要使用過度權限的 Key

---

## 八、故障排除

### 8.1 常見問題

#### 問題 1: "Cannot GET /login"
**原因**: Supabase 環境變數未設定  
**解決**: 檢查 `NEXT_PUBLIC_SUPABASE_URL` 和 `NEXT_PUBLIC_SUPABASE_ANON_KEY`

#### 問題 2: LLM 回應失敗
**原因**: `GOOGLE_API_KEY` 未設定或無效  
**解決**: 檢查 API Key 是否正確，是否有足夠配額

#### 問題 3: 語音合成失敗
**原因**: `ELEVENLABS_API_KEY` 或 `ELEVENLABS_VOICE_ID` 未設定  
**解決**: 檢查 API Key 和 Voice ID 是否正確

#### 問題 4: 記憶系統無法運作
**原因**: Cloudflare 環境變數未設定（如果使用 Cloudflare）  
**解決**: 檢查 Cloudflare 相關環境變數，或改用 Supabase 儲存

---

## 九、完整環境變數模板

### 9.1 最小配置（核心功能）

```env
# 最小配置 - 僅核心功能
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
NEXT_PUBLIC_SITE_URL=https://your-domain.com
GOOGLE_API_KEY=xxx
ELEVENLABS_API_KEY=xxx
ELEVENLABS_VOICE_ID=xxx
```

### 9.2 完整配置（所有功能）

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
NEXT_PUBLIC_SITE_URL=https://your-domain.com

# LLM
GOOGLE_API_KEY=xxx
ANTHROPIC_API_KEY=xxx

# ElevenLabs
ELEVENLABS_API_KEY=xxx
ELEVENLABS_VOICE_ID=xxx
ELEVENLABS_MODEL_ID=eleven_multilingual_v2

# Cloudflare
CLOUDFLARE_KV_NAMESPACE=xxx
CLOUDFLARE_ACCOUNT_ID=xxx
CLOUDFLARE_API_TOKEN=xxx
NEXT_PUBLIC_MEMORY_URL=https://xxx.workers.dev
NEXT_PUBLIC_TIMELINE_URL=https://xxx.workers.dev
```

---

## 十、快速參考表

### 10.1 必需環境變數快速表

| 變數名稱 | 優先級 | 用途 | 取得位置 |
|---------|--------|------|----------|
| `NEXT_PUBLIC_SUPABASE_URL` | 🔴 最高 | 認證與資料庫 | Supabase Dashboard |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | 🔴 最高 | 認證與資料庫 | Supabase Dashboard |
| `NEXT_PUBLIC_SITE_URL` | 🔴 最高 | 網站 URL | 部署平台 |
| `GOOGLE_API_KEY` | 🔴 最高 | LLM 對話生成 | Google AI Studio |
| `ELEVENLABS_API_KEY` | 🔴 最高 | 語音合成 | ElevenLabs |
| `ELEVENLABS_VOICE_ID` | 🔴 最高 | 語音 ID | ElevenLabs |

### 10.2 可選環境變數快速表

| 變數名稱 | 優先級 | 用途 | 取得位置 |
|---------|--------|------|----------|
| `ANTHROPIC_API_KEY` | 🟡 中等 | 備選 LLM | Anthropic Console |
| `ELEVENLABS_MODEL_ID` | 🟡 中等 | 語音模型 | ElevenLabs（有預設值） |
| `CLOUDFLARE_KV_NAMESPACE` | 🟢 低 | 記憶系統 | Cloudflare Dashboard |
| `CLOUDFLARE_ACCOUNT_ID` | 🟢 低 | 記憶系統 | Cloudflare Dashboard |
| `CLOUDFLARE_API_TOKEN` | 🟢 低 | 記憶系統 | Cloudflare Dashboard |
| `NEXT_PUBLIC_MEMORY_URL` | 🟢 低 | 記憶 API | Cloudflare Workers |
| `NEXT_PUBLIC_TIMELINE_URL` | 🟢 低 | 時間軸 API | Cloudflare Workers |

---

## 十一、參考文件

- `megan/ENV_SETUP.md` - Megan 環境變數設定指南
- `megan/SETUP.md` - Megan 完整設定指南
- `電子書童開發計畫.md` - 電子書童開發計畫
- `megan/docs/principles.md` - 技術開發五大原則

---

**文件版本**: v1.0  
**最後更新**: 2025-01-XX  
**維護者**: 開發團隊

